<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Notatnik — transkrypcja głosu</title>
<style>
  :root{--bg:#0f1720;--card:#0b1220;--accent:#22c55e;--muted:#94a3b8;--text:#e6eef6}
  html,body{height:100%;margin:0;font-family:Inter,Roboto,system-ui,-apple-system,"Segoe UI",sans-serif;background:linear-gradient(180deg,#071128 0%, #071826 100%);color:var(--text)}
  .app{max-width:900px;margin:18px auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button,select{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:8px 10px;border-radius:8px;font-size:14px}
  button.primary{background:linear-gradient(90deg,#16a34a,#22c55e);color:#032; border:0}
  button.warn{background:linear-gradient(90deg,#ef4444,#f97316);color:#fff;border:0}
  main{display:grid;grid-template-columns:1fr 320px;gap:12px}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
  #editor{min-height:420px;resize:vertical;padding:10px;background:transparent;border:1px dashed rgba(255,255,255,0.03);border-radius:8px;color:var(--text);outline:none;font-size:15px}
  .status{font-size:13px;color:var(--muted);margin-top:8px}
  .interim{color:#ffd43b;opacity:0.9}
  .note-item{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);cursor:pointer}
  .note-item small{display:block;color:var(--muted);font-size:12px}
  .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .footer{margin-top:12px;color:var(--muted);font-size:13px}
  @media(max-width:880px){main{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Notatnik — transkrypcja głosu (real-time)</h1>
    <div class="controls">
      <select id="lang">
        <option value="pl-PL">Polski — pl-PL</option>
        <option value="en-US">English — en-US</option>
        <option value="de-DE">Deutsch — de-DE</option>
        <option value="fr-FR">Français — fr-FR</option>
      </select>
      <button id="startBtn" class="primary">Start</button>
      <button id="stopBtn">Stop</button>
      <button id="saveBtn">Zapisz notatkę</button>
      <button id="exportBtn">Eksportuj .txt</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div style="display:flex;gap:8px;align-items:center;">
        <div id="micIcon" style="width:14px;height:14px;border-radius:50%;background:#ef4444;"></div>
        <div>
          <div><strong>Transkrypcja (na żywo)</strong></div>
          <div id="recStatus" class="status">Nieaktywne</div>
        </div>
      </div>

      <div id="editor" contenteditable="true" spellcheck="true" aria-label="Edytor notatki"></div>

      <div class="status">
        <span id="interim" class="interim"></span>
      </div>

      <div class="actions">
        <button id="clearBtn">Wyczyść</button>
        <button id="insertTimeBtn">Wstaw czas</button>
        <button id="togglePunctBtn">Automatyczna interpunkcja: <span id="punctState">ON</span></button>
      </div>

      <div class="footer">
        Uwaga: do transkrypcji używany jest Web Speech API (SpeechRecognition). Jeśli rozpoznawanie nie działa w Brave, spróbuj przeglądarki Chrome lub sprawdź uprawnienia mikrofonu.
      </div>
    </section>

    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Moje notatki</strong>
        <button id="clearAllBtn" class="warn">Usuń wszystko</button>
      </div>
      <div id="notesList"></div>
    </aside>
  </main>
</div>

<script>
/*
  Notatnik — transkrypcja głosu na tekst (real-time)
  Autor: Web Crafter (przykład)
*/

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const saveBtn = document.getElementById('saveBtn');
const exportBtn = document.getElementById('exportBtn');
const clearBtn = document.getElementById('clearBtn');
const insertTimeBtn = document.getElementById('insertTimeBtn');
const togglePunctBtn = document.getElementById('togglePunctBtn');
const punctStateSpan = document.getElementById('punctState');
const langSelect = document.getElementById('lang');

const editor = document.getElementById('editor');
const recStatus = document.getElementById('recStatus');
const interimSpan = document.getElementById('interim');
const micIcon = document.getElementById('micIcon');

const notesList = document.getElementById('notesList');
const clearAllBtn = document.getElementById('clearAllBtn');

let recognition = null;
let recognizing = false;
let lastResultIndex = 0;
let usePunctuation = true;

// Local storage key
const STORAGE_KEY = 'notatnik_notes_v1';

// Init speech recognition
function initRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    recStatus.textContent = 'Twoja przeglądarka nie wspiera Web Speech API.';
    micIcon.style.background = '#888';
    return null;
  }

  const r = new SpeechRecognition();
  r.lang = langSelect.value || 'pl-PL';
  r.interimResults = true;
  r.maxAlternatives = 1;
  r.continuous = true;
  
  r.onstart = () => {
    recognizing = true;
    recStatus.textContent = 'Nasłuchuję — mów teraz...';
    micIcon.style.background = 'linear-gradient(90deg,#22c55e,#16a34a)';
  };
  r.onend = () => {
    recognizing = false;
    recStatus.textContent = 'Zatrzymano';
    micIcon.style.background = '#ef4444';
    if (shouldAutoRestart) {
      try { r.start(); } catch(e){ /* ignore */ }
    }
  };
  r.onerror = (ev) => {
    console.error('SpeechRecognition error', ev);
    recStatus.textContent = 'Błąd rozpoznawania: ' + (ev.error || 'unknown');
  };

  r.onresult = (ev) => {
    let interim = '';
    let finalTranscript = '';
    for (let i = ev.resultIndex; i < ev.results.length; ++i) {
      const res = ev.results[i];
      if (res.isFinal) {
        finalTranscript += res[0].transcript;
      } else {
        interim += res[0].transcript;
      }
    }

    if (usePunctuation && finalTranscript.trim()) {
      finalTranscript = applySimplePunctuation(finalTranscript);
    }

    if (finalTranscript) {
      insertTextAtCursor(finalTranscript + ' ');
    }
    interimSpan.textContent = interim;
  };

  return r;
}

function applySimplePunctuation(text) {
  text = text.trim();
  if (!text) return text;
  text = text.replace(/^[a-ząćęłńóśżź]/u, s => s.toUpperCase());
  if (!/[.!?]$/.test(text)) text = text + '.';
  return text + ' ';
}

function insertTextAtCursor(text) {
  editor.focus();
  const sel = window.getSelection();
  if (!sel.rangeCount) {
    editor.innerText += text;
    return;
  }
  const range = sel.getRangeAt(0);
  range.collapse(false);
  const node = document.createTextNode(text);
  range.insertNode(node);
  range.setStartAfter(node);
  range.setEndAfter(node);
  sel.removeAllRanges();
  sel.addRange(range);
  editor.scrollTop = editor.scrollHeight;
}

let shouldAutoRestart = true;

startBtn.addEventListener('click', ()=>{
  if (!recognition) recognition = initRecognition();
  if (!recognition) return alert('Transkrypcja głosu nie jest wspierana w tej przeglądarce.');
  recognition.lang = langSelect.value;
  shouldAutoRestart = true;
  try {
    recognition.start();
  } catch(e) {
    try { recognition.stop(); recognition.start(); } catch(e2){ console.warn(e2); }
  }
});

stopBtn.addEventListener('click', ()=>{
  shouldAutoRestart = false;
  if (recognition) recognition.stop();
  recStatus.textContent = 'Zatrzymywanie...';
});

langSelect.addEventListener('change', ()=>{
  if (recognition) {
    const wasRunning = recognizing;
    shouldAutoRestart = false;
    recognition.stop();
    recognition = null;
    if (wasRunning) {
      setTimeout(()=>{ startBtn.click(); }, 250);
    }
  }
});

saveBtn.addEventListener('click', ()=>{
  const text = editor.innerText.trim();
  if (!text) return alert('Notatka jest pusta — nic do zapisu.');
  const notes = loadNotes();
  notes.unshift({id: Date.now(), text, created: new Date().toISOString()});
  localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
  renderNotes();
  alert('Notatka zapisana lokalnie.');
});

exportBtn.addEventListener('click', ()=>{
  const content = editor.innerText;
  const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'notatka-' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

clearBtn.addEventListener('click', ()=>{
  if (confirm('Na pewno wyczyścić edytor?')) editor.innerText = '';
});

insertTimeBtn.addEventListener('click', ()=>{
  const now = new Date();
  const stamp = now.toLocaleString();
  insertTextAtCursor('[' + stamp + '] ');
});

togglePunctBtn.addEventListener('click', ()=>{
  usePunctuation = !usePunctuation;
  punctStateSpan.textContent = usePunctuation ? 'ON' : 'OFF';
});

function loadNotes() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    return JSON.parse(raw);
  } catch(e) { return []; }
}

function renderNotes() {
  const notes = loadNotes();
  notesList.innerHTML = '';
  if (!notes.length) {
    notesList.innerHTML = '<div style="color:var(--muted)">Brak zapisanych notatek.</div>';
    return;
  }
  notes.forEach(n => {
    const div = document.createElement('div');
    div.className = 'note-item';
    div.innerHTML = `<strong>${(n.text||'').slice(0,120).replace(/\n/g,' ')}${(n.text.length>120?'…':'')}</strong><small>${new Date(n.created).toLocaleString()}</small>`;
    div.addEventListener('click', ()=>{
      editor.innerText = n.text;
      window.scrollTo({top:0,behavior:'smooth'});
    });
    div.addEventListener('contextmenu', (ev)=>{
      ev.preventDefault();
      if (confirm('Usuń tę notatkę?')) {
        deleteNote(n.id);
      }
    });
    notesList.appendChild(div);
  });
}

function deleteNote(id) {
  const notes = loadNotes().filter(n => n.id !== id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
  renderNotes();
}

clearAllBtn.addEventListener('click', ()=>{
  if (confirm('Usunąć wszystkie notatki z localStorage?')) {
    localStorage.removeItem(STORAGE_KEY);
    renderNotes();
  }
});

document.addEventListener('DOMContentLoaded', ()=>{
  renderNotes();
  if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
    recStatus.textContent = 'Web Speech API NIEDOSTĘPNE w tej przeglądarce.';
    micIcon.style.background = '#888';
  } else {
    recStatus.textContent = 'Gotowy. Kliknij Start, aby rozpocząć transkrypcję.';
    micIcon.style.background = '#ef4444';
  }
});

document.addEventListener('keydown', (e)=>{
  if (e.ctrlKey && e.key.toLowerCase() === 'k') { e.preventDefault(); startBtn.click(); }
  if (e.ctrlKey && e.key.toLowerCase() === 'l') { e.preventDefault(); stopBtn.click(); }
});

// --- prosty autosave draft co 15s ---
setInterval(() => {
  const text = editor.innerText.trim();
  if (text) {
    const draft = { text, updated: new Date().toISOString() };
    localStorage.setItem('notatnik_draft', JSON.stringify(draft));
  }
}, 15000);

// przy starcie wczytaj draft (jeśli istnieje)
document.addEventListener('DOMContentLoaded', () => {
  const raw = localStorage.getItem('notatnik_draft');
  if (raw) {
    try {
      const d = JSON.parse(raw);
      if (d && d.text) {
        if (!editor.innerText.trim()) {
          editor.innerText = d.text;
        }
      }
    } catch (e) {
      console.error("Błąd przy wczytywaniu draftu", e);
    }
  }
});
</script>
</body>
</html>
